"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var pluginHtmlparser2=require("@selderee/plugin-htmlparser2"),htmlparser2=require("htmlparser2"),selderee=require("selderee"),merge=require("deepmerge"),domSerializer=require("dom-serializer");function _interopDefaultLegacy(e){return e&&"object"===typeof e&&"default"in e?e:{default:e}}var merge__default=_interopDefaultLegacy(merge);function limitedDepthRecursive(e,t,r=(()=>{})){if(void 0===e){const e=function(...r){return t(e,...r)};return e}return e>=0?function(...n){return t(limitedDepthRecursive(e-1,t,r),...n)}:r}function trimCharacter(e,t){let r=0,n=e.length;for(;r<n&&e[r]===t;)++r;for(;n>r&&e[n-1]===t;)--n;return r>0||n<e.length?e.substring(r,n):e}function trimCharacterEnd(e,t){let r=e.length;for(;r>0&&e[r-1]===t;)--r;return r<e.length?e.substring(0,r):e}function unicodeEscape(e){return e.replace(/[\s\S]/g,(e=>"\\u"+e.charCodeAt().toString(16).padStart(4,"0")))}function mergeDuplicatesPreferLast(e,t){const r=new Map;for(let n=e.length;n-- >0;){const i=e[n],s=t(i);r.set(s,r.has(s)?merge__default.default(i,r.get(s),{arrayMerge:overwriteMerge$1}):i)}return[...r.values()].reverse()}const overwriteMerge$1=(e,t,r)=>[...t];function get(e,t){for(const r of t){if(!e)return;e=e[r]}return e}function numberToLetterSequence(e,t="a",r=26){const n=[];do{e-=1,n.push(e%r),e=e/r>>0}while(e>0);const i=t.charCodeAt(0);return n.reverse().map((e=>String.fromCharCode(i+e))).join("")}const I=["I","X","C","M"],V=["V","L","D"];function numberToRoman(e){return[...e+""].map((e=>+e)).reverse().map(((e,t)=>e%5<4?(e<5?"":V[t])+I[t].repeat(e%5):I[t]+(e<5?V[t]:I[t+1]))).reverse().join("")}class InlineTextBuilder{constructor(e,t=void 0){this.lines=[],this.nextLineWords=[],this.maxLineLength=t||e.wordwrap||Number.MAX_VALUE,this.nextLineAvailableChars=this.maxLineLength,this.wrapCharacters=get(e,["longWordSplit","wrapCharacters"])||[],this.forceWrapOnLimit=get(e,["longWordSplit","forceWrapOnLimit"])||!1,this.stashedSpace=!1,this.wordBreakOpportunity=!1}pushWord(e,t=!1){this.nextLineAvailableChars<=0&&!t&&this.startNewLine();const r=0===this.nextLineWords.length,n=e.length+(r?0:1);if(n<=this.nextLineAvailableChars||t)this.nextLineWords.push(e),this.nextLineAvailableChars-=n;else{const[t,...n]=this.splitLongWord(e);r||this.startNewLine(),this.nextLineWords.push(t),this.nextLineAvailableChars-=t.length;for(const e of n)this.startNewLine(),this.nextLineWords.push(e),this.nextLineAvailableChars-=e.length}}popWord(){const e=this.nextLineWords.pop();if(void 0!==e){const t=0===this.nextLineWords.length,r=e.length+(t?0:1);this.nextLineAvailableChars+=r}return e}concatWord(e,t=!1){if(this.wordBreakOpportunity&&e.length>this.nextLineAvailableChars)this.pushWord(e,t),this.wordBreakOpportunity=!1;else{const r=this.popWord();this.pushWord(r?r.concat(e):e,t)}}startNewLine(e=1){this.lines.push(this.nextLineWords),e>1&&this.lines.push(...Array.from({length:e-1},(()=>[]))),this.nextLineWords=[],this.nextLineAvailableChars=this.maxLineLength}isEmpty(){return 0===this.lines.length&&0===this.nextLineWords.length}clear(){this.lines.length=0,this.nextLineWords.length=0,this.nextLineAvailableChars=this.maxLineLength}toString(){return[...this.lines,this.nextLineWords].map((e=>e.join(" "))).join("\n")}splitLongWord(e){const t=[];let r=0;for(;e.length>this.maxLineLength;){const n=e.substring(0,this.maxLineLength),i=e.substring(this.maxLineLength),s=n.lastIndexOf(this.wrapCharacters[r]);if(s>-1)e=n.substring(s+1)+i,t.push(n.substring(0,s+1));else{if(r++,!(r<this.wrapCharacters.length)){if(this.forceWrapOnLimit){if(t.push(n),(e=i).length>this.maxLineLength)continue}else e=n+i;break}e=n+i}}return t.push(e),t}}class StackItem{constructor(e=null){this.next=e}getRoot(){return this.next?this.next:this}}class BlockStackItem extends StackItem{constructor(e,t=null,r=1,n=void 0){super(t),this.leadingLineBreaks=r,this.inlineTextBuilder=new InlineTextBuilder(e,n),this.rawText="",this.stashedLineBreaks=0,this.isPre=t&&t.isPre,this.isNoWrap=t&&t.isNoWrap}}class ListStackItem extends BlockStackItem{constructor(e,t=null,{interRowLineBreaks:r=1,leadingLineBreaks:n=2,maxLineLength:i,maxPrefixLength:s=0,prefixAlign:a="left"}={}){super(e,t,n,i),this.maxPrefixLength=s,this.prefixAlign=a,this.interRowLineBreaks=r}}class ListItemStackItem extends BlockStackItem{constructor(e,t=null,{leadingLineBreaks:r=1,maxLineLength:n,prefix:i=""}={}){super(e,t,r,n),this.prefix=i}}class TableStackItem extends StackItem{constructor(e=null){super(e),this.rows=[],this.isPre=e&&e.isPre,this.isNoWrap=e&&e.isNoWrap}}class TableRowStackItem extends StackItem{constructor(e=null){super(e),this.cells=[],this.isPre=e&&e.isPre,this.isNoWrap=e&&e.isNoWrap}}class TableCellStackItem extends StackItem{constructor(e,t=null,r=void 0){super(t),this.inlineTextBuilder=new InlineTextBuilder(e,r),this.rawText="",this.stashedLineBreaks=0,this.isPre=t&&t.isPre,this.isNoWrap=t&&t.isNoWrap}}class TransformerStackItem extends StackItem{constructor(e=null,t){super(e),this.transform=t}}function charactersToCodes(e){return[...e].map((e=>"\\u"+e.charCodeAt(0).toString(16).padStart(4,"0"))).join("")}class WhitespaceProcessor{constructor(e){this.whitespaceChars=e.preserveNewlines?e.whitespaceCharacters.replace(/\n/g,""):e.whitespaceCharacters;const t=charactersToCodes(this.whitespaceChars);if(this.leadingWhitespaceRe=new RegExp(`^[${t}]`),this.trailingWhitespaceRe=new RegExp(`[${t}]$`),this.allWhitespaceOrEmptyRe=new RegExp(`^[${t}]*$`),this.newlineOrNonWhitespaceRe=new RegExp(`(\\n|[^\\n${t}])`,"g"),this.newlineOrNonNewlineStringRe=new RegExp("(\\n|[^\\n]+)","g"),e.preserveNewlines){const e=new RegExp(`\\n|[^\\n${t}]+`,"gm");this.shrinkWrapAdd=function(t,r,n=(e=>e),i=!1){if(!t)return;const s=r.stashedSpace;let a=!1,o=e.exec(t);if(o)for(a=!0,"\n"===o[0]?r.startNewLine():s||this.testLeadingWhitespace(t)?r.pushWord(n(o[0]),i):r.concatWord(n(o[0]),i);null!==(o=e.exec(t));)"\n"===o[0]?r.startNewLine():r.pushWord(n(o[0]),i);r.stashedSpace=s&&!a||this.testTrailingWhitespace(t)}}else{const e=new RegExp(`[^${t}]+`,"g");this.shrinkWrapAdd=function(t,r,n=(e=>e),i=!1){if(!t)return;const s=r.stashedSpace;let a=!1,o=e.exec(t);if(o)for(a=!0,s||this.testLeadingWhitespace(t)?r.pushWord(n(o[0]),i):r.concatWord(n(o[0]),i);null!==(o=e.exec(t));)r.pushWord(n(o[0]),i);r.stashedSpace=s&&!a||this.testTrailingWhitespace(t)}}}addLiteral(e,t,r=!0){if(!e)return;const n=t.stashedSpace;let i=!1,s=this.newlineOrNonNewlineStringRe.exec(e);if(s)for(i=!0,"\n"===s[0]?t.startNewLine():n?t.pushWord(s[0],r):t.concatWord(s[0],r);null!==(s=this.newlineOrNonNewlineStringRe.exec(e));)"\n"===s[0]?t.startNewLine():t.pushWord(s[0],r);t.stashedSpace=n&&!i}testLeadingWhitespace(e){return this.leadingWhitespaceRe.test(e)}testTrailingWhitespace(e){return this.trailingWhitespaceRe.test(e)}testContainsWords(e){return!this.allWhitespaceOrEmptyRe.test(e)}countNewlinesNoWords(e){this.newlineOrNonWhitespaceRe.lastIndex=0;let t,r=0;for(;null!==(t=this.newlineOrNonWhitespaceRe.exec(e));){if("\n"!==t[0])return 0;r++}return r}}class BlockTextBuilder{constructor(e,t,r=void 0){this.options=e,this.picker=t,this.metadata=r,this.whitespaceProcessor=new WhitespaceProcessor(e),this._stackItem=new BlockStackItem(e),this._wordTransformer=void 0}pushWordTransform(e){this._wordTransformer=new TransformerStackItem(this._wordTransformer,e)}popWordTransform(){if(!this._wordTransformer)return;const e=this._wordTransformer.transform;return this._wordTransformer=this._wordTransformer.next,e}startNoWrap(){this._stackItem.isNoWrap=!0}stopNoWrap(){this._stackItem.isNoWrap=!1}_getCombinedWordTransformer(){const e=this._wordTransformer?e=>applyTransformer(e,this._wordTransformer):void 0,t=this.options.encodeCharacters;return e?t?r=>t(e(r)):e:t}_popStackItem(){const e=this._stackItem;return this._stackItem=e.next,e}addLineBreak(){(this._stackItem instanceof BlockStackItem||this._stackItem instanceof ListItemStackItem||this._stackItem instanceof TableCellStackItem)&&(this._stackItem.isPre?this._stackItem.rawText+="\n":this._stackItem.inlineTextBuilder.startNewLine())}addWordBreakOpportunity(){(this._stackItem instanceof BlockStackItem||this._stackItem instanceof ListItemStackItem||this._stackItem instanceof TableCellStackItem)&&(this._stackItem.inlineTextBuilder.wordBreakOpportunity=!0)}addInline(e,{noWordTransform:t=!1}={}){if(this._stackItem instanceof BlockStackItem||this._stackItem instanceof ListItemStackItem||this._stackItem instanceof TableCellStackItem)if(this._stackItem.isPre)this._stackItem.rawText+=e;else if(0!==e.length&&(!this._stackItem.stashedLineBreaks||this.whitespaceProcessor.testContainsWords(e))){if(this.options.preserveNewlines){const t=this.whitespaceProcessor.countNewlinesNoWords(e);if(t>0)return void this._stackItem.inlineTextBuilder.startNewLine(t)}this._stackItem.stashedLineBreaks&&this._stackItem.inlineTextBuilder.startNewLine(this._stackItem.stashedLineBreaks),this.whitespaceProcessor.shrinkWrapAdd(e,this._stackItem.inlineTextBuilder,t?void 0:this._getCombinedWordTransformer(),this._stackItem.isNoWrap),this._stackItem.stashedLineBreaks=0}}addLiteral(e){(this._stackItem instanceof BlockStackItem||this._stackItem instanceof ListItemStackItem||this._stackItem instanceof TableCellStackItem)&&0!==e.length&&(this._stackItem.isPre?this._stackItem.rawText+=e:(this._stackItem.stashedLineBreaks&&this._stackItem.inlineTextBuilder.startNewLine(this._stackItem.stashedLineBreaks),this.whitespaceProcessor.addLiteral(e,this._stackItem.inlineTextBuilder,this._stackItem.isNoWrap),this._stackItem.stashedLineBreaks=0))}openBlock({leadingLineBreaks:e=1,reservedLineLength:t=0,isPre:r=!1}={}){const n=Math.max(20,this._stackItem.inlineTextBuilder.maxLineLength-t);this._stackItem=new BlockStackItem(this.options,this._stackItem,e,n),r&&(this._stackItem.isPre=!0)}closeBlock({trailingLineBreaks:e=1,blockTransform:t}={}){const r=this._popStackItem(),n=t?t(getText(r)):getText(r);addText(this._stackItem,n,r.leadingLineBreaks,Math.max(r.stashedLineBreaks,e))}openList({maxPrefixLength:e=0,prefixAlign:t="left",interRowLineBreaks:r=1,leadingLineBreaks:n=2}={}){this._stackItem=new ListStackItem(this.options,this._stackItem,{interRowLineBreaks:r,leadingLineBreaks:n,maxLineLength:this._stackItem.inlineTextBuilder.maxLineLength,maxPrefixLength:e,prefixAlign:t})}openListItem({prefix:e=""}={}){if(!(this._stackItem instanceof ListStackItem))throw new Error("Can't add a list item to something that is not a list! Check the formatter.");const t=this._stackItem,r=Math.max(e.length,t.maxPrefixLength),n=Math.max(20,t.inlineTextBuilder.maxLineLength-r);this._stackItem=new ListItemStackItem(this.options,t,{prefix:e,maxLineLength:n,leadingLineBreaks:t.interRowLineBreaks})}closeListItem(){const e=this._popStackItem(),t=e.next,r=Math.max(e.prefix.length,t.maxPrefixLength),n="\n"+" ".repeat(r);addText(t,("right"===t.prefixAlign?e.prefix.padStart(r):e.prefix.padEnd(r))+getText(e).replace(/\n/g,n),e.leadingLineBreaks,Math.max(e.stashedLineBreaks,t.interRowLineBreaks))}closeList({trailingLineBreaks:e=2}={}){const t=this._popStackItem(),r=getText(t);r&&addText(this._stackItem,r,t.leadingLineBreaks,e)}openTable(){this._stackItem=new TableStackItem(this._stackItem)}openTableRow(){if(!(this._stackItem instanceof TableStackItem))throw new Error("Can't add a table row to something that is not a table! Check the formatter.");this._stackItem=new TableRowStackItem(this._stackItem)}openTableCell({maxColumnWidth:e}={}){if(!(this._stackItem instanceof TableRowStackItem))throw new Error("Can't add a table cell to something that is not a table row! Check the formatter.");this._stackItem=new TableCellStackItem(this.options,this._stackItem,e)}closeTableCell({colspan:e=1,rowspan:t=1}={}){const r=this._popStackItem(),n=trimCharacter(getText(r),"\n");r.next.cells.push({colspan:e,rowspan:t,text:n})}closeTableRow(){const e=this._popStackItem();e.next.rows.push(e.cells)}closeTable({tableToString:e,leadingLineBreaks:t=2,trailingLineBreaks:r=2}){const n=e(this._popStackItem().rows);n&&addText(this._stackItem,n,t,r)}toString(){return getText(this._stackItem.getRoot())}}function getText(e){if(!(e instanceof BlockStackItem||e instanceof ListItemStackItem||e instanceof TableCellStackItem))throw new Error("Only blocks, list items and table cells can be requested for text contents.");return e.inlineTextBuilder.isEmpty()?e.rawText:e.rawText+e.inlineTextBuilder.toString()}function addText(e,t,r,n){if(!(e instanceof BlockStackItem||e instanceof ListItemStackItem||e instanceof TableCellStackItem))throw new Error("Only blocks, list items and table cells can contain text.");const i=getText(e),s=Math.max(e.stashedLineBreaks,r);e.inlineTextBuilder.clear(),i?e.rawText=i+"\n".repeat(s)+t:(e.rawText=t,e.leadingLineBreaks=s),e.stashedLineBreaks=n}function applyTransformer(e,t){return t?applyTransformer(t.transform(e),t.next):e}function compile$1(e={}){const t=e.selectors.filter((e=>!e.format));if(t.length)throw new Error("Following selectors have no specified format: "+t.map((e=>`\`${e.selector}\``)).join(", "));const r=new selderee.DecisionTree(e.selectors.map((e=>[e.selector,e]))).build(pluginHtmlparser2.hp2Builder);"function"!==typeof e.encodeCharacters&&(e.encodeCharacters=makeReplacerFromDict(e.encodeCharacters));const n=new selderee.DecisionTree(e.baseElements.selectors.map(((e,t)=>[e,t+1]))).build(pluginHtmlparser2.hp2Builder);function i(t){return findBases(t,e,n)}const s=limitedDepthRecursive(e.limits.maxDepth,recursiveWalk,(function(t,r){r.addInline(e.limits.ellipsis||"")}));return function(t,n=void 0){return process(t,n,e,r,i,s)}}function process(e,t,r,n,i,s){const a=r.limits.maxInputLength;a&&e&&e.length>a&&(console.warn(`Input length ${e.length} is above allowed limit of ${a}. Truncating without ellipsis.`),e=e.substring(0,a));const o=i(htmlparser2.parseDocument(e,{decodeEntities:r.decodeEntities}).children),l=new BlockTextBuilder(r,n,t);return s(o,l),l.toString()}function findBases(e,t,r){const n=[];const i=limitedDepthRecursive(t.limits.maxDepth,(function(e,i){i=i.slice(0,t.limits.maxChildNodes);for(const s of i){if("tag"!==s.type)continue;const i=r.pick1(s);if(i>0?n.push({selectorIndex:i,element:s}):s.children&&e(s.children),n.length>=t.limits.maxBaseElements)return}}));return i(e),"occurrence"!==t.baseElements.orderBy&&n.sort(((e,t)=>e.selectorIndex-t.selectorIndex)),t.baseElements.returnDomByDefault&&0===n.length?e:n.map((e=>e.element))}function recursiveWalk(e,t,r){if(!t)return;const n=r.options;t.length>n.limits.maxChildNodes&&(t=t.slice(0,n.limits.maxChildNodes)).push({data:n.limits.ellipsis,type:"text"});for(const i of t)switch(i.type){case"text":r.addInline(i.data);break;case"tag":{const t=r.picker.pick1(i);(0,n.formatters[t.format])(i,e,r,t.options||{});break}}}function makeReplacerFromDict(e){if(!e||0===Object.keys(e).length)return;const t=Object.entries(e).filter((([,e])=>!1!==e)),r=new RegExp(t.map((([e])=>`(${unicodeEscape([...e][0])})`)).join("|"),"g"),n=t.map((([,e])=>e)),i=(e,...t)=>n[t.findIndex((e=>e))];return e=>e.replace(r,i)}function formatSkip(e,t,r,n){}function formatInlineString(e,t,r,n){r.addLiteral(n.string||"")}function formatBlockString(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),r.addLiteral(n.string||""),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatInline(e,t,r,n){t(e.children,r)}function formatBlock$1(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function renderOpenTag(e){const t=e.attribs&&e.attribs.length?" "+Object.entries(e.attribs).map((([e,t])=>""===t?e:`${e}=${t.replace(/"/g,"&quot;")}`)).join(" "):"";return`<${e.name}${t}>`}function renderCloseTag(e){return`</${e.name}>`}function formatInlineTag(e,t,r,n){r.startNoWrap(),r.addLiteral(renderOpenTag(e)),r.stopNoWrap(),t(e.children,r),r.startNoWrap(),r.addLiteral(renderCloseTag(e)),r.stopNoWrap()}function formatBlockTag(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),r.startNoWrap(),r.addLiteral(renderOpenTag(e)),r.stopNoWrap(),t(e.children,r),r.startNoWrap(),r.addLiteral(renderCloseTag(e)),r.stopNoWrap(),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatInlineHtml(e,t,r,n){r.startNoWrap(),r.addLiteral(domSerializer.render(e,{decodeEntities:r.options.decodeEntities})),r.stopNoWrap()}function formatBlockHtml(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),r.startNoWrap(),r.addLiteral(domSerializer.render(e,{decodeEntities:r.options.decodeEntities})),r.stopNoWrap(),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatInlineSurround(e,t,r,n){r.addLiteral(n.prefix||""),t(e.children,r),r.addLiteral(n.suffix||"")}var genericFormatters=Object.freeze({__proto__:null,block:formatBlock$1,blockHtml:formatBlockHtml,blockString:formatBlockString,blockTag:formatBlockTag,inline:formatInline,inlineHtml:formatInlineHtml,inlineString:formatInlineString,inlineSurround:formatInlineSurround,inlineTag:formatInlineTag,skip:formatSkip});function getRow(e,t){return e[t]||(e[t]=[]),e[t]}function findFirstVacantIndex(e,t=0){for(;e[t];)t++;return t}function transposeInPlace(e,t){for(let r=0;r<t;r++){const t=getRow(e,r);for(let n=0;n<r;n++){const i=getRow(e,n);if(t[n]||i[r]){const e=t[n];t[n]=i[r],i[r]=e}}}}function putCellIntoLayout(e,t,r,n){for(let i=0;i<e.rowspan;i++){const s=getRow(t,r+i);for(let t=0;t<e.colspan;t++)s[n+t]=e}}function getOrInitOffset(e,t){return void 0===e[t]&&(e[t]=0===t?0:1+getOrInitOffset(e,t-1)),e[t]}function updateOffset(e,t,r,n){e[t+r]=Math.max(getOrInitOffset(e,t+r),getOrInitOffset(e,t)+n)}function tableToString(e,t,r){const n=[];let i=0;const s=e.length,a=[0];for(let c=0;c<s;c++){const r=getRow(n,c),s=e[c];let o=0;for(let e=0;e<s.length;e++){const i=s[e];o=findFirstVacantIndex(r,o),putCellIntoLayout(i,n,c,o),o+=i.colspan,i.lines=i.text.split("\n");const l=i.lines.length;updateOffset(a,c,i.rowspan,l+t)}i=r.length>i?r.length:i}transposeInPlace(n,s>i?s:i);const o=[],l=[0];for(let c=0;c<i;c++){let e,t=0;const i=Math.min(s,n[c].length);for(;t<i;)if(e=n[c][t],e){if(!e.rendered){let n=0;for(let r=0;r<e.lines.length;r++){const i=e.lines[r],s=a[t]+r;o[s]=(o[s]||"").padEnd(l[c])+i,n=i.length>n?i.length:n}updateOffset(l,c,e.colspan,n+r),e.rendered=!0}t+=e.rowspan}else{const e=a[t];o[e]=o[e]||"",t++}}return o.join("\n")}function formatLineBreak(e,t,r,n){r.addLineBreak()}function formatWbr(e,t,r,n){r.addWordBreakOpportunity()}function formatHorizontalLine(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),r.addInline("-".repeat(n.length||r.options.wordwrap||40)),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatParagraph(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatPre(e,t,r,n){r.openBlock({isPre:!0,leadingLineBreaks:n.leadingLineBreaks||2}),t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatHeading(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2}),!1!==n.uppercase?(r.pushWordTransform((e=>e.toUpperCase())),t(e.children,r),r.popWordTransform()):t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2})}function formatBlockquote(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks||2,reservedLineLength:2}),t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks||2,blockTransform:e=>(!1!==n.trimEmptyLines?trimCharacter(e,"\n"):e).split("\n").map((e=>"> "+e)).join("\n")})}function withBrackets(e,t){if(!t)return e;return("string"===typeof t[0]?t[0]:"[")+e+("string"===typeof t[1]?t[1]:"]")}function pathRewrite(e,t,r,n,i){const s="function"===typeof t?t(e,n,i):e;return"/"===s[0]&&r?trimCharacterEnd(r,"/")+s:s}function formatImage(e,t,r,n){const i=e.attribs||{},s=i.alt?i.alt:"",a=i.src?pathRewrite(i.src,n.pathRewrite,n.baseUrl,r.metadata,e):"",o=a?s?s+" "+withBrackets(a,n.linkBrackets):withBrackets(a,n.linkBrackets):s;r.addInline(o,{noWordTransform:!0})}function formatAnchor(e,t,r,n){const i=function(){if(n.ignoreHref)return"";if(!e.attribs||!e.attribs.href)return"";let t=e.attribs.href.replace(/^mailto:/,"");return n.noAnchorUrl&&"#"===t[0]?"":(t=pathRewrite(t,n.pathRewrite,n.baseUrl,r.metadata,e),t)}();if(i){let s="";r.pushWordTransform((e=>(e&&(s+=e),e))),t(e.children,r),r.popWordTransform();n.hideLinkHrefIfSameAsText&&i===s||r.addInline(s?" "+withBrackets(i,n.linkBrackets):i,{noWordTransform:!0})}else t(e.children,r)}function formatList(e,t,r,n,i){const s="li"===get(e,["parent","name"]);let a=0;const o=(e.children||[]).filter((e=>"text"!==e.type||!/^\s*$/.test(e.data))).map((function(e){if("li"!==e.name)return{node:e,prefix:""};const t=s?i().trimStart():i();return t.length>a&&(a=t.length),{node:e,prefix:t}}));if(o.length){r.openList({interRowLineBreaks:1,leadingLineBreaks:s?1:n.leadingLineBreaks||2,maxPrefixLength:a,prefixAlign:"left"});for(const{node:e,prefix:n}of o)r.openListItem({prefix:n}),t([e],r),r.closeListItem();r.closeList({trailingLineBreaks:s?1:n.trailingLineBreaks||2})}}function formatUnorderedList(e,t,r,n){const i=n.itemPrefix||" * ";return formatList(e,t,r,n,(()=>i))}function formatOrderedList(e,t,r,n){let i=Number(e.attribs.start||"1");const s=getOrderedListIndexFunction(e.attribs.type);return formatList(e,t,r,n,(()=>" "+s(i++)+". "))}function getOrderedListIndexFunction(e="1"){switch(e){case"a":return e=>numberToLetterSequence(e,"a");case"A":return e=>numberToLetterSequence(e,"A");case"i":return e=>numberToRoman(e).toLowerCase();case"I":return e=>numberToRoman(e);default:return e=>e.toString()}}function splitClassesAndIds(e){const t=[],r=[];for(const n of e)n.startsWith(".")?t.push(n.substring(1)):n.startsWith("#")&&r.push(n.substring(1));return{classes:t,ids:r}}function isDataTable(e,t){if(!0===t)return!0;if(!e)return!1;const{classes:r,ids:n}=splitClassesAndIds(t),i=(e.class||"").split(" "),s=(e.id||"").split(" ");return i.some((e=>r.includes(e)))||s.some((e=>n.includes(e)))}function formatTable(e,t,r,n){return isDataTable(e.attribs,r.options.tables)?formatDataTable(e,t,r,n):formatBlock(e,t,r,n)}function formatBlock(e,t,r,n){r.openBlock({leadingLineBreaks:n.leadingLineBreaks}),t(e.children,r),r.closeBlock({trailingLineBreaks:n.trailingLineBreaks})}function formatDataTable(e,t,r,n){function i(e){const i=+get(e,["attribs","colspan"])||1,s=+get(e,["attribs","rowspan"])||1;r.openTableCell({maxColumnWidth:n.maxColumnWidth}),t(e.children,r),r.closeTableCell({colspan:i,rowspan:s})}r.openTable(),e.children.forEach((function e(t){if("tag"!==t.type)return;const s=!1!==n.uppercaseHeaderCells?e=>{r.pushWordTransform((e=>e.toUpperCase())),i(e),r.popWordTransform()}:i;switch(t.name){case"thead":case"tbody":case"tfoot":case"center":return void t.children.forEach(e);case"tr":r.openTableRow();for(const e of t.children)if("tag"===e.type)switch(e.name){case"th":s(e);break;case"td":i(e)}r.closeTableRow()}})),r.closeTable({tableToString:e=>tableToString(e,n.rowSpacing??0,n.colSpacing??3),leadingLineBreaks:n.leadingLineBreaks,trailingLineBreaks:n.trailingLineBreaks})}var textFormatters=Object.freeze({__proto__:null,anchor:formatAnchor,blockquote:formatBlockquote,dataTable:formatDataTable,heading:formatHeading,horizontalLine:formatHorizontalLine,image:formatImage,lineBreak:formatLineBreak,orderedList:formatOrderedList,paragraph:formatParagraph,pre:formatPre,table:formatTable,unorderedList:formatUnorderedList,wbr:formatWbr});const DEFAULT_OPTIONS={baseElements:{selectors:["body"],orderBy:"selectors",returnDomByDefault:!0},decodeEntities:!0,encodeCharacters:{},formatters:{},limits:{ellipsis:"...",maxBaseElements:void 0,maxChildNodes:void 0,maxDepth:void 0,maxInputLength:1<<24},longWordSplit:{forceWrapOnLimit:!1,wrapCharacters:[]},preserveNewlines:!1,selectors:[{selector:"*",format:"inline"},{selector:"a",format:"anchor",options:{baseUrl:null,hideLinkHrefIfSameAsText:!1,ignoreHref:!1,linkBrackets:["[","]"],noAnchorUrl:!0}},{selector:"article",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"aside",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"blockquote",format:"blockquote",options:{leadingLineBreaks:2,trailingLineBreaks:2,trimEmptyLines:!0}},{selector:"br",format:"lineBreak"},{selector:"div",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"footer",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"form",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"h1",format:"heading",options:{leadingLineBreaks:3,trailingLineBreaks:2,uppercase:!0}},{selector:"h2",format:"heading",options:{leadingLineBreaks:3,trailingLineBreaks:2,uppercase:!0}},{selector:"h3",format:"heading",options:{leadingLineBreaks:3,trailingLineBreaks:2,uppercase:!0}},{selector:"h4",format:"heading",options:{leadingLineBreaks:2,trailingLineBreaks:2,uppercase:!0}},{selector:"h5",format:"heading",options:{leadingLineBreaks:2,trailingLineBreaks:2,uppercase:!0}},{selector:"h6",format:"heading",options:{leadingLineBreaks:2,trailingLineBreaks:2,uppercase:!0}},{selector:"header",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"hr",format:"horizontalLine",options:{leadingLineBreaks:2,length:void 0,trailingLineBreaks:2}},{selector:"img",format:"image",options:{baseUrl:null,linkBrackets:["[","]"]}},{selector:"main",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"nav",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"ol",format:"orderedList",options:{leadingLineBreaks:2,trailingLineBreaks:2}},{selector:"p",format:"paragraph",options:{leadingLineBreaks:2,trailingLineBreaks:2}},{selector:"pre",format:"pre",options:{leadingLineBreaks:2,trailingLineBreaks:2}},{selector:"section",format:"block",options:{leadingLineBreaks:1,trailingLineBreaks:1}},{selector:"table",format:"table",options:{colSpacing:3,leadingLineBreaks:2,maxColumnWidth:60,rowSpacing:0,trailingLineBreaks:2,uppercaseHeaderCells:!0}},{selector:"ul",format:"unorderedList",options:{itemPrefix:" * ",leadingLineBreaks:2,trailingLineBreaks:2}},{selector:"wbr",format:"wbr"}],tables:[],whitespaceCharacters:" \t\r\n\f\u200b",wordwrap:80},concatMerge=(e,t,r)=>[...e,...t],overwriteMerge=(e,t,r)=>[...t],selectorsMerge=(e,t,r)=>e.some((e=>"object"===typeof e))?concatMerge(e,t):overwriteMerge(e,t);function compile(e={}){return(e=merge__default.default(DEFAULT_OPTIONS,e,{arrayMerge:overwriteMerge,customMerge:e=>"selectors"===e?selectorsMerge:void 0})).formatters=Object.assign({},genericFormatters,textFormatters,e.formatters),e.selectors=mergeDuplicatesPreferLast(e.selectors,(e=>e.selector)),handleDeprecatedOptions(e),compile$1(e)}function convert(e,t={},r=void 0){return compile(t)(e,r)}function handleDeprecatedOptions(e){if(e.tags){const t=Object.entries(e.tags).map((([e,t])=>({...t,selector:e||"*"})));e.selectors.push(...t),e.selectors=mergeDuplicatesPreferLast(e.selectors,(e=>e.selector))}function t(e,t,r){const n=t.pop();for(const i of t){let t=e[i];t||(t={},e[i]=t),e=t}e[n]=r}if(e.baseElement){const r=e.baseElement;t(e,["baseElements","selectors"],Array.isArray(r)?r:[r])}void 0!==e.returnDomByDefault&&t(e,["baseElements","returnDomByDefault"],e.returnDomByDefault);for(const r of e.selectors)"anchor"===r.format&&get(r,["options","noLinkBrackets"])&&t(r,["options","linkBrackets"],!1)}exports.compile=compile,exports.convert=convert,exports.htmlToText=convert;